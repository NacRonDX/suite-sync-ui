<div class="rooms-container">
  <div class="rooms-header">
    <div class="header-content">
      <div>
        <h1 class="rooms-title">All Rooms</h1>
        <p class="rooms-subtitle">Manage and view all hotel rooms</p>
      </div>
      @if (isAdmin) {
        <button class="btn-create-room" (click)="openCreateModal()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
          Create Room
        </button>
      }
    </div>
  </div>

  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner-large"></div>
      <p>Loading rooms...</p>
    </div>
  }

  @if (!isLoading && errorMessage) {
    <div class="error-container">
      <svg
        class="icon-error"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <p class="error-text">{{ errorMessage }}</p>
      <button class="btn-retry" (click)="loadRooms()">Try Again</button>
    </div>
  }

  @if (!isLoading && !errorMessage && rooms.length === 0) {
    <div class="empty-state">
      <svg
        class="icon-empty"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <line x1="9" y1="9" x2="15" y2="15"></line>
        <line x1="15" y1="9" x2="9" y2="15"></line>
      </svg>
      <p class="empty-text">No rooms available</p>
    </div>
  }

  @if (!isLoading && !errorMessage && rooms.length > 0) {
    @if (isAdmin) {
      <div class="rooms-stats">
        <div class="stat-card">
          <div class="stat-value">{{ rooms.length }}</div>
          <div class="stat-label">Total Rooms</div>
        </div>
        <div class="stat-card stat-available">
          <div class="stat-value">{{ availableRooms }}</div>
          <div class="stat-label">Available</div>
        </div>
        <div class="stat-card stat-occupied">
          <div class="stat-value">{{ occupiedRooms }}</div>
          <div class="stat-label">Occupied</div>
        </div>
        <div class="stat-card stat-maintenance">
          <div class="stat-value">{{ maintenanceRooms }}</div>
          <div class="stat-label">Maintenance</div>
        </div>
        <div class="stat-card stat-out-of-service">
          <div class="stat-value">{{ outOfServiceRooms }}</div>
          <div class="stat-label">Out of Service</div>
        </div>
      </div>
    }

    <div class="rooms-grid">
      @for (room of rooms; track room.id) {
        <div class="room-card">
          @if (room.images && room.images.length > 0) {
            <div class="room-carousel">
              <div class="carousel-container">
                @for (image of room.images; track $index) {
                  <div
                    class="carousel-image"
                    [class.active]="$index === getCurrentImageIndex(room.id)"
                    [style.backgroundImage]="'url(' + image + ')'"></div>
                }
              </div>
              <button
                class="carousel-btn carousel-prev"
                (click)="prevImage(room.id, room.images.length, $event)"
                [style.display]="room.images.length > 1 ? 'flex' : 'none'">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round">
                  <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
              </button>
              <button
                class="carousel-btn carousel-next"
                (click)="nextImage(room.id, room.images.length, $event)"
                [style.display]="room.images.length > 1 ? 'flex' : 'none'">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round">
                  <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
              </button>
              @if (room.images.length > 1) {
                <div class="carousel-indicators">
                  @for (image of room.images; track $index) {
                    <span
                      class="indicator"
                      [class.active]="$index === getCurrentImageIndex(room.id)"
                      (click)="setImageIndex(room.id, $index, $event)">
                    </span>
                  }
                </div>
              }
              <span class="room-status" [ngClass]="getStatusClass(room.status)">
                {{ getStatusText(room.status) }}
              </span>
            </div>
          } @else {
            <div class="room-image-placeholder">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round">
                <rect x="3" y="3" width="7" height="7"></rect>
                <rect x="14" y="3" width="7" height="7"></rect>
                <rect x="14" y="14" width="7" height="7"></rect>
                <rect x="3" y="14" width="7" height="7"></rect>
              </svg>
              <span class="room-status" [ngClass]="getStatusClass(room.status)">
                {{ getStatusText(room.status) }}
              </span>
            </div>
          }

          <div class="room-content" (click)="viewRoomDetails(room.id)">
            <div class="room-header">
              <h3 class="room-number">Room {{ room.roomNumber }}</h3>
              <span class="room-type">{{
                getRoomTypeDisplay(room.roomType)
              }}</span>
            </div>

            <p class="room-description">{{ room.description }}</p>

            <div class="room-details">
              <div class="detail-item">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span
                  >{{ room.maxOccupancy }}
                  {{ room.maxOccupancy === 1 ? 'Guest' : 'Guests' }}</span
                >
              </div>

              <div class="detail-item">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round">
                  <path
                    d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                </svg>
                <span>{{ room.size }} m²</span>
              </div>

              <div class="detail-item">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round">
                  <line x1="3" y1="6" x2="21" y2="6"></line>
                  <line x1="3" y1="12" x2="21" y2="12"></line>
                  <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
                <span>Floor {{ room.floor }}</span>
              </div>
            </div>

            @if (room.amenities && room.amenities.length > 0) {
              <div class="room-amenities">
                <h4 class="amenities-title">Amenities</h4>
                <div class="amenities-list">
                  @for (amenity of room.amenities; track amenity) {
                    <span class="amenity-tag">{{ amenity }}</span>
                  }
                </div>
              </div>
            }

            <div class="room-footer">
              <div class="room-price">
                <span class="price-label">Per Night</span>
                <span class="price-value">{{
                  formatPrice(room.pricePerNight)
                }}</span>
              </div>
              @if (isAuthenticated && room.status === 'AVAILABLE') {
                <button
                  class="btn-book"
                  (click)="openBookingModal(room, $event)">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round">
                    <rect
                      x="3"
                      y="4"
                      width="18"
                      height="18"
                      rx="2"
                      ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                  </svg>
                  Book Now
                </button>
              }
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>

@if (showCreateModal) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create New Room</h2>
        <button class="btn-close" (click)="closeCreateModal()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      @if (createErrorMessage) {
        <div class="error-message">
          {{ createErrorMessage }}
        </div>
      }

      <form class="create-form" (ngSubmit)="createRoom()">
        <div class="form-row">
          <div class="form-group">
            <label for="roomNumber">Room Number *</label>
            <input
              type="text"
              id="roomNumber"
              [(ngModel)]="newRoom.roomNumber"
              name="roomNumber"
              required
              maxlength="10"
              placeholder="e.g., 101" />
          </div>

          <div class="form-group">
            <label for="roomType">Room Type *</label>
            <select
              id="roomType"
              [(ngModel)]="newRoom.roomType"
              name="roomType"
              required>
              @for (type of roomTypes; track type) {
                <option [value]="type">{{ getRoomTypeDisplay(type) }}</option>
              }
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="maxOccupancy">Max Occupancy *</label>
            <input
              type="number"
              id="maxOccupancy"
              [(ngModel)]="newRoom.maxOccupancy"
              name="maxOccupancy"
              required
              min="1"
              max="10"
              placeholder="e.g., 2" />
          </div>

          <div class="form-group">
            <label for="pricePerNight">Price Per Night ($) *</label>
            <input
              type="number"
              id="pricePerNight"
              [(ngModel)]="newRoom.pricePerNight"
              name="pricePerNight"
              required
              min="0"
              step="0.01"
              placeholder="e.g., 150.00" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="size">Size (m²) *</label>
            <input
              type="number"
              id="size"
              [(ngModel)]="newRoom.size"
              name="size"
              required
              min="0"
              step="0.1"
              placeholder="e.g., 25.5" />
          </div>

          <div class="form-group">
            <label for="floor">Floor</label>
            <input
              type="number"
              id="floor"
              [(ngModel)]="newRoom.floor"
              name="floor"
              min="0"
              placeholder="e.g., 1" />
          </div>
        </div>

        <div class="form-group">
          <label for="description">Description</label>
          <textarea
            id="description"
            [(ngModel)]="newRoom.description"
            name="description"
            maxlength="1000"
            rows="3"
            placeholder="Enter a detailed description of the room"></textarea>
        </div>

        <div class="form-group">
          <label>Amenities</label>
          <div class="input-with-button">
            <input
              type="text"
              [(ngModel)]="amenityInput"
              name="amenityInput"
              placeholder="e.g., WiFi, TV, Air Conditioning"
              (keyup.enter)="addAmenity()" />
            <button type="button" class="btn-add" (click)="addAmenity()">
              Add
            </button>
          </div>
          @if (newRoom.amenities && newRoom.amenities.length > 0) {
            <div class="tags-list">
              @for (amenity of newRoom.amenities; track amenity) {
                <span class="tag">
                  {{ amenity }}
                  <button
                    type="button"
                    class="tag-remove"
                    (click)="removeAmenity(amenity)">
                    ×
                  </button>
                </span>
              }
            </div>
          }
        </div>

        <div class="form-group">
          <label>Images</label>
          <div class="input-with-button">
            <input
              type="url"
              [(ngModel)]="imageInput"
              name="imageInput"
              placeholder="Enter image URL"
              (keyup.enter)="addImage()" />
            <button type="button" class="btn-add" (click)="addImage()">
              Add
            </button>
          </div>
          @if (newRoom.images && newRoom.images.length > 0) {
            <div class="images-list">
              @for (image of newRoom.images; track image) {
                <div class="image-item">
                  <img [src]="image" alt="Room preview" />
                  <button
                    type="button"
                    class="btn-remove-image"
                    (click)="removeImage(image)">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
              }
            </div>
          }
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeCreateModal()"
            [disabled]="isCreating">
            Cancel
          </button>
          <button type="submit" class="btn-submit" [disabled]="isCreating">
            @if (isCreating) {
              <span class="spinner-small"></span>
              Creating...
            } @else {
              Create Room
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}

@if (showBookingModal && selectedRoom) {
  <div class="modal-overlay" (click)="closeBookingModal()">
    <div class="modal-content booking-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Book Room {{ selectedRoom.roomNumber }}</h2>
        <button class="btn-close" (click)="closeBookingModal()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      @if (bookingSuccessMessage) {
        <div class="success-message">
          {{ bookingSuccessMessage }}
        </div>
      }

      @if (bookingErrorMessage) {
        <div class="error-message">
          {{ bookingErrorMessage }}
        </div>
      }

      @if (availabilityErrorMessage) {
        <div class="error-message">
          {{ availabilityErrorMessage }}
        </div>
      }

      <div class="booking-form">
        <div class="room-summary">
          <h3>Room Details</h3>
          <div class="summary-item">
            <span class="label">Room Type:</span>
            <span class="value">{{
              getRoomTypeDisplay(selectedRoom.roomType)
            }}</span>
          </div>
          <div class="summary-item">
            <span class="label">Max Occupancy:</span>
            <span class="value"
              >{{ selectedRoom.maxOccupancy }}
              {{ selectedRoom.maxOccupancy === 1 ? 'Guest' : 'Guests' }}</span
            >
          </div>
          <div class="summary-item">
            <span class="label">Price Per Night:</span>
            <span class="value">{{
              formatPrice(selectedRoom.pricePerNight)
            }}</span>
          </div>
        </div>

        <div class="form-section">
          <div class="form-row">
            <div class="form-group">
              <label for="checkInDate">Check-in Date *</label>
              <input
                type="date"
                id="checkInDate"
                [(ngModel)]="checkInDate"
                [min]="minCheckInDate"
                (change)="availability = null"
                required />
            </div>

            <div class="form-group">
              <label for="checkOutDate">Check-out Date *</label>
              <input
                type="date"
                id="checkOutDate"
                [(ngModel)]="checkOutDate"
                [min]="minCheckOutDate"
                (change)="availability = null"
                required />
            </div>
          </div>

          <div class="form-group">
            <label for="numberOfGuests">Number of Guests *</label>
            <input
              type="number"
              id="numberOfGuests"
              [(ngModel)]="numberOfGuests"
              [min]="1"
              [max]="selectedRoom.maxOccupancy"
              required />
          </div>

          <div class="form-group">
            <label for="specialRequests">Special Requests</label>
            <textarea
              id="specialRequests"
              [(ngModel)]="specialRequests"
              maxlength="500"
              rows="3"
              placeholder="Enter any special requests (optional)"></textarea>
          </div>

          <button
            type="button"
            class="btn-check-availability"
            (click)="checkAvailability()"
            [disabled]="
              isCheckingAvailability || !checkInDate || !checkOutDate
            ">
            @if (isCheckingAvailability) {
              <span class="spinner-small"></span>
              Checking...
            } @else {
              Check Availability
            }
          </button>

          @if (availability) {
            <div class="availability-result">
              @if (availability.available) {
                <div class="availability-success">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                  <span>Room is available!</span>
                </div>
                <div class="booking-summary">
                  <div class="summary-row">
                    <span>Number of Nights:</span>
                    <span>{{ availability.numberOfNights }}</span>
                  </div>
                  <div class="summary-row">
                    <span>Price per Night:</span>
                    <span>{{ formatPrice(availability.pricePerNight) }}</span>
                  </div>
                  <div class="summary-row total">
                    <span>Total Price:</span>
                    <span>{{ formatPrice(availability.totalPrice) }}</span>
                  </div>
                </div>
              } @else {
                <div class="availability-error">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="15" y1="9" x2="9" y2="15"></line>
                    <line x1="9" y1="9" x2="15" y2="15"></line>
                  </svg>
                  <span>Room is not available for these dates</span>
                </div>
              }
            </div>
          }
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn-cancel"
            (click)="closeBookingModal()"
            [disabled]="isBooking">
            Cancel
          </button>
          <button
            type="button"
            class="btn-submit"
            (click)="bookRoom()"
            [disabled]="
              isBooking ||
              !availability ||
              !availability.available ||
              !checkInDate ||
              !checkOutDate ||
              !numberOfGuests
            ">
            @if (isBooking) {
              <span class="spinner-small"></span>
              Booking...
            } @else {
              Confirm Booking
            }
          </button>
        </div>
      </div>
    </div>
  </div>
}
